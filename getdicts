#!/bin/sh

# ISO639
LANG="pl"

# ISO 3166-1 ALPHA-2
LOCALE="PL"

ENCODING="ISO8859-2"
IDENTIFIER="${LANG}_${LOCALE}"

echo "Creating PostgreSQL dictionary files for \"$IDENTIFIER\"";

if command -v apt-get > /dev/null; then
	echo "Debian/Ubuntu detected - using apt";
	PACKAGE="hunspell-$LANG"

  if ! dpkg -V "$PACKAGE"; then
		echo "Installing through apt-get"
		sudo apt-get install --yes "$PACKAGE";
	fi;

	for ext in aff dic; do
		echo "Using local $IDENTIFIER.$ext";
		SYSTEM_FILE=$(dpkg -L "$PACKAGE" | grep "$IDENTIFIER.$ext");
		iconv -f "$ENCODING" -t utf8 -o "./$IDENTIFIER.utf8.$ext" "$SYSTEM_FILE";
	done;
else
	for ext in aff dic; do
		echo "Downloading $IDENTIFIER.$ext";
		## Download and convert to UTF-8 from $ENCODING
		wget "https://raw.githubusercontent.com/LibreOffice/dictionaries/master/$IDENTIFIER/$IDENTIFIER.$ext" -O - |
		iconv -f "$ENCODING" -t utf8 -o "$IDENTIFIER.utf8.$ext";
	done;
fi;



## also a bit of processing.. 
# 1. PostgreSQL wants .affix and .dict,
#    LibreOffice uses .aff and .dic
# 2. Remove first line of dic (from docs)
#    > The first  line of the dictionaries (except personal dictionaries) contains
#    > the approximate word count (for optimal hash memory  size).
# 3. Removes blank lines and sorts dict
sed -e '1d' -e '/^$/d' "$IDENTIFIER.utf8.dic" | sort > "$IDENTIFIER.dict"
mv "$IDENTIFIER.utf8.aff" "$IDENTIFIER.affix"
rm "$IDENTIFIER.utf8.dic";

# Offer to install in Debian/Ubuntu
if command -v apt-get > /dev/null 2>&1 &&
 	command -v pg_config > /dev/null 2>&1;
then

	PG_TSEARCH_DATA="$(pg_config --sharedir)/tsearch_data";
	PG_VERSION=$(pg_config --version);
	echo "Attempting install for $PG_VERSION to $PG_TSEARCH_DATA";
	sudo cp -v "$LANG.stop" "$IDENTIFIER.affix" "$IDENTIFIER.dict" "$PG_TSEARCH_DATA"

fi;

echo "Finished!"
